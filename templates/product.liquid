<section class="product-page">
  <div class="product-media">
    {% if product.media.size > 0 %}
      {% assign main_image = nil %}
      {% for media in product.media %}
        {% if media.media_type == "image" %}
          {% assign main_image = media %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% if main_image %}
        <div class="product-gallery" data-gallery>
          <div class="product-main">
            <img
              src="{{ main_image | image_url: width: 1200 }}"
              alt="{{ main_image.alt | escape }}"
              loading="lazy"
              data-main-image
              data-zoom="{{ main_image | image_url: width: 2000 }}"
            >
          </div>
          <!-- Thumbnails kept but simplified by CSS -->
          <div class="product-thumbs">
            {% assign thumb_index = 0 %}
            {% for media in product.media %}
              {% if media.media_type == "image" %}
                <button
                  class="product-thumb{% if thumb_index == 0 %} is-active{% endif %}"
                  type="button"
                  data-thumb
                  data-index="{{ thumb_index }}"
                  data-large="{{ media | image_url: width: 900 }}"
                  data-zoom="{{ media | image_url: width: 1600 }}"
                  data-alt="{{ media.alt | escape }}"
                  aria-label="View image {{ thumb_index | plus: 1 }}"
                >
                  <img
                    src="{{ media | image_url: width: 200 }}"
                    alt="{{ media.alt | escape }}"
                    loading="lazy"
                  >
                </button>
                {% assign thumb_index = thumb_index | plus: 1 %}
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% else %}
        <div class="product-placeholder">No images yet.</div>
      {% endif %}
    {% else %}
      <div class="product-placeholder">No images yet.</div>
    {% endif %}
  </div>

  <div class="product-info">
    {% assign current_variant = product.selected_or_first_available_variant %}
    <h1 class="product-title">{{ product.title }}</h1>
    <div class="product-price" data-product-price>
      <span class="product-price-value">{{ current_variant.price | money }}</span>
      <span class="product-compare" {% if current_variant.compare_at_price <= current_variant.price %}hidden{% endif %}>
        {{ current_variant.compare_at_price | money }}
      </span>
    </div>

    {% form 'product', product, class: 'product-form' %}
      {% if product.variants.size > 1 %}
        <div class="product-options" data-options>
          {% for option in product.options_with_values %}
            <div class="product-option" data-option-index="{{ forloop.index0 }}">
              <div class="product-label">{{ option.name }}</div>
              <div class="product-option__values">
                {% for value in option.values %}
                  <button
                    class="product-option__value"
                    type="button"
                    data-option-value="{{ value }}"
                    aria-pressed="false"
                  >
                    {{ value }}
                  </button>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
        <label class="product-label visually-hidden" for="variantSelect">Variant</label>
        <select id="variantSelect" name="id" class="product-select is-hidden" data-variant-select>
          {% for variant in product.variants %}
            <option
              value="{{ variant.id }}"
              data-price="{{ variant.price | money }}"
              data-compare="{{ variant.compare_at_price | money }}"
              data-price-amount="{{ variant.price }}"
              data-compare-amount="{{ variant.compare_at_price }}"
              data-available="{{ variant.available }}"
              {% if variant.id == current_variant.id %}selected{% endif %}
              {% unless variant.available %}disabled{% endunless %}
            >
              {{ variant.title }} - {{ variant.price | money }}
            </option>
          {% endfor %}
        </select>
      {% else %}
        <input type="hidden" name="id" value="{{ current_variant.id }}">
      {% endif %}

      <div class="product-form-row">
        <div class="qty-wrapper">
             <label class="visually-hidden" for="quantity">Quantity</label>
             <!-- Simplified Quantity Input to match design ( - 1 + ) -->
             <div class="qty-control" style="display: flex; align-items: center; border: 1px solid #e0e0e0; width: fit-content;">
                <button type="button" class="qty-btn" data-qty-minus aria-label="Decrease quantity" style="border: none; background: transparent; padding: 12px; cursor: pointer; color: #1a1a1a;">&minus;</button>
                <input id="quantity" class="product-qty" type="number" name="quantity" value="1" min="1" step="1" style="border: none; text-align: center; width: 40px; padding: 0; appearance: none; -moz-appearance: textfield;">
                <button type="button" class="qty-btn" data-qty-plus aria-label="Increase quantity" style="border: none; background: transparent; padding: 12px; cursor: pointer; color: #1a1a1a;">&plus;</button>
             </div>
        </div>

        <button
            type="submit"
            class="btn primary"
            data-add-to-cart
            {% unless current_variant.available %}disabled{% endunless %}
        >
            {% if current_variant.available %}Add to cart{% else %}Sold out{% endif %}
        </button>
      </div>
      
      {% if current_variant.available %}
        <button type="button" class="btn secondary">Buy it now</button>
      {% endif %}

      <!-- Accordions -->
      <div class="product-accordions">
        <div class="accordion-item">
            <button class="accordion-header" type="button" aria-expanded="false">
                Care & Maintenance
                <span class="accordion-icon">+</span>
            </button>
            <div class="accordion-content">
                <p>Gentle cleaning with a soft cloth. Avoid harsh chemicals.</p>
            </div>
        </div>
        <div class="accordion-item">
            <button class="accordion-header" type="button" aria-expanded="false">
                Shipping & Returns
                <span class="accordion-icon">+</span>
            </button>
            <div class="accordion-content">
                <p>Free shipping on orders over $100. Returns accepted within 30 days.</p>
            </div>
        </div>
        <div class="accordion-item">
            <button class="accordion-header" type="button" aria-expanded="false">
                Material
                <span class="accordion-icon">+</span>
            </button>
            <div class="accordion-content">
                {% if product.description != blank %}
                  <div class="product-description">{{ product.description }}</div>
                {% else %}
                  <p>Premium sterling silver or 14k gold vermeil.</p>
                {% endif %}
            </div>
        </div>
      </div>
    {% endform %}

    <a class="cart-link" href="/cart">View cart</a>
  </div>
</section>

<div class="product-lightbox" data-lightbox aria-hidden="true">
  <button class="product-lightbox__close" type="button" data-lightbox-close aria-label="Close image">✕</button>
  <button class="product-lightbox__nav product-lightbox__nav--prev" type="button" data-lightbox-prev aria-label="Previous image">‹</button>
  <img class="product-lightbox__image" data-lightbox-image alt="">
  <button class="product-lightbox__nav product-lightbox__nav--next" type="button" data-lightbox-next aria-label="Next image">›</button>
</div>

<script>
  (() => {
    const variants = {{ product.variants | json }};
    const gallery = document.querySelector("[data-gallery]");
    const mainImage = gallery?.querySelector("[data-main-image]");
    const thumbs = gallery ? [...gallery.querySelectorAll("[data-thumb]")] : [];

    if (gallery && mainImage && thumbs.length > 0) {
      const setActive = (btn) => {
        if (!btn) return;
        const nextSrc = btn.dataset.large;
        const nextAlt = btn.dataset.alt || "";
        const nextZoom = btn.dataset.zoom || nextSrc;
        if (nextSrc) mainImage.src = nextSrc;
        mainImage.alt = nextAlt;
        if (nextZoom) mainImage.dataset.zoom = nextZoom;
        thumbs.forEach((thumb) => {
          thumb.classList.toggle("is-active", thumb === btn);
        });
      };

      thumbs.forEach((btn) => {
        btn.addEventListener("click", () => setActive(btn));
      });

      if (thumbs.length <= 1) {
        gallery.classList.add("is-single");
      }
    }

    const lightbox = document.querySelector("[data-lightbox]");
    const lightboxImg = lightbox?.querySelector("[data-lightbox-image]");
    const lightboxClose = lightbox?.querySelector("[data-lightbox-close]");
    const lightboxPrev = lightbox?.querySelector("[data-lightbox-prev]");
    const lightboxNext = lightbox?.querySelector("[data-lightbox-next]");
    if (lightbox && lightboxImg && mainImage) {
      const sources = thumbs.map((btn) => ({
        zoom: btn.dataset.zoom || btn.dataset.large,
        alt: btn.dataset.alt || "",
      }));
      let currentIndex = thumbs.findIndex((btn) => btn.classList.contains("is-active"));

      const showAt = (idx) => {
        if (!sources.length) return;
        currentIndex = (idx + sources.length) % sources.length;
        const next = sources[currentIndex];
        lightboxImg.src = next.zoom;
        lightboxImg.alt = next.alt;
      };

      const openLightbox = () => {
        const activeIndex = thumbs.findIndex((btn) => btn.classList.contains("is-active"));
        showAt(activeIndex >= 0 ? activeIndex : 0);
        lightbox.classList.add("is-open");
        lightbox.setAttribute("aria-hidden", "false");
      };
      const closeLightbox = () => {
        lightbox.classList.remove("is-open");
        lightbox.setAttribute("aria-hidden", "true");
      };

      mainImage.addEventListener("click", openLightbox);
      lightbox.addEventListener("click", (e) => {
        if (e.target === lightbox) closeLightbox();
      });
      lightboxClose.addEventListener("click", closeLightbox);
      lightboxPrev?.addEventListener("click", (e) => {
        e.stopPropagation();
        showAt(currentIndex - 1);
      });
      lightboxNext?.addEventListener("click", (e) => {
        e.stopPropagation();
        showAt(currentIndex + 1);
      });
      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") closeLightbox();
        if (lightbox.classList.contains("is-open")) {
          if (e.key === "ArrowLeft") showAt(currentIndex - 1);
          if (e.key === "ArrowRight") showAt(currentIndex + 1);
        }
      });
    }

    const variantSelect = document.getElementById("variantSelect");
    if (!variantSelect) return;

    const priceWrap = document.querySelector("[data-product-price]");
    const priceValue = priceWrap?.querySelector(".product-price-value");
    const compareValue = priceWrap?.querySelector(".product-compare");
    const addBtn = document.querySelector("[data-add-to-cart]");
    const optionGroups = document.querySelectorAll("[data-option-index]");

    function updateFromOption(option){
      if (!option) return;
      if (priceValue) priceValue.textContent = option.dataset.price || "";

      if (compareValue) {
        const priceAmount = Number(option.dataset.priceAmount || 0);
        const compareAmount = Number(option.dataset.compareAmount || 0);
        if (compareAmount > priceAmount) {
          compareValue.textContent = option.dataset.compare || "";
          compareValue.hidden = false;
        } else {
          compareValue.hidden = true;
        }
      }

      if (addBtn) {
        const available = option.dataset.available === "true";
        addBtn.disabled = !available;
        addBtn.textContent = available ? "Add to cart" : "Sold out";
      }
    }

    updateFromOption(variantSelect.selectedOptions?.[0]);
    variantSelect.addEventListener("change", (e) => {
      updateFromOption(e.target.selectedOptions?.[0]);
    });

    if (optionGroups.length && variants.length) {
      const findVariant = (selected) =>
        variants.find((v) => v.options.every((opt, idx) => opt === selected[idx]));

      let selectedOptions =
        variants.find((v) => v.id === Number(variantSelect.value))?.options || [];

      const syncButtons = () => {
        optionGroups.forEach((group) => {
          const index = Number(group.dataset.optionIndex);
          group.querySelectorAll("[data-option-value]").forEach((btn) => {
            const active = btn.dataset.optionValue === selectedOptions[index];
            btn.classList.toggle("is-active", active);
            btn.setAttribute("aria-pressed", active ? "true" : "false");
          });
        });
      };

      syncButtons();

      optionGroups.forEach((group) => {
        const index = Number(group.dataset.optionIndex);
        group.querySelectorAll("[data-option-value]").forEach((btn) => {
          btn.addEventListener("click", () => {
            selectedOptions[index] = btn.dataset.optionValue;
            const match = findVariant(selectedOptions);
            if (match) {
              variantSelect.value = match.id;
              variantSelect.dispatchEvent(new Event("change", { bubbles: true }));
            }
            syncButtons();
          });
        });
      });

      variantSelect.addEventListener("change", () => {
        selectedOptions =
          variants.find((v) => v.id === Number(variantSelect.value))?.options || selectedOptions;
        syncButtons();
      });
    }

    // Accordion Logic
    const accordions = document.querySelectorAll(".accordion-header");
    accordions.forEach(header => {
        header.addEventListener("click", () => {
            const content = header.nextElementSibling;
            const isOpen = content.classList.contains("is-open");
            
            // Close others if desired (optional, keeping independent here)
            // accordions.forEach(h => {
            //    if(h !== header) {
            //        h.nextElementSibling.classList.remove("is-open");
            //        h.querySelector(".accordion-icon").textContent = "+";
            //    }
            // });

            content.classList.toggle("is-open");
            header.setAttribute("aria-expanded", !isOpen);
            header.querySelector(".accordion-icon").textContent = isOpen ? "+" : "-";
        });
    });

    // Quantity Logic
    const qtyInput = document.getElementById("quantity");
    const minusBtn = document.querySelector("[data-qty-minus]");
    const plusBtn = document.querySelector("[data-qty-plus]");

    if(qtyInput && minusBtn && plusBtn) {
        minusBtn.addEventListener("click", () => {
            const val = parseInt(qtyInput.value) || 1;
            if(val > 1) qtyInput.value = val - 1;
        });
        plusBtn.addEventListener("click", () => {
            const val = parseInt(qtyInput.value) || 1;
            qtyInput.value = val + 1;
        });
    }

  })();
</script>
